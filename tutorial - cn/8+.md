## 8+. 采集能量(面向对象)
  - [状态节点](#状态节点)
  - [状态模式](#状态模式)
  - [最终代码](#最终代码)

本节教程将介绍如何通过`CreepLogic`类的状态节点和状态模式来实现与8.md等同的能量采集逻辑，这是一种更结构化、更可维护的方式。

### 状态节点

`CreepLogic`继承自`Stage`类，因此其具备`有限行为状态机`(FBM: Finite Behavior-State Machine)的功能，或简称`行为机`。 其核心是状态节点，当每个状态节点都是一个方法，通过返回值来切换状态。
* 本例只考虑其状态机功能，不考虑其行为树功能

```python
from builtin import *

class Demo(Stage):
    NAME = "Demo" 

    def state0(self, it: any, k: GlobalKnowledge):
        return "state1"

    def state1(self):
        return "idle"
    
    def idle(self):
        return  # 保持状态

    def _state2(self):
        pass  # 以_开头，不是一个状态节点
```

| 状态节点特性 | 描述 |
|------------|------|
| 命名规则 | 方法名不能以`_`开头 |
| 初始状态 | 第一个定义的状态节点 |
| 状态切换 | 通过返回状态节点名称字符串来实现 |
| 保持状态 | 返回当前状态节点名称字符串 |

### 状态模式

`Logic`及其子类都可以自动地执行`行为机`，执行位置与其他方法的执行顺序如下：

- main.py 的`step`方法
- 执行`状态节点`
- `onStep`方法

在教程8，需要两个状态:
- 采集状态，从Source采集能量
- 存储状态，将能量存储到Spawn

#### 采集状态
```python
def harvest_state(self, creep: Creep, k: GlobalKnowledge):
    """采集状态 - 对应8.md中的采集逻辑"""
    # 执行采集操作
    creep.harvest(SOURCE)
    # 检查能量是否已满
    if creep.energy >= creep.energyMax:
        # 能量满了，切换到存储状态
        return "deposit_state"
    # 能量未满，继续采集状态(返回None)
```

#### 存储状态
```python
def deposit_state(self, creep: Creep, k: GlobalKnowledge):
    """存储状态 - 对应8.md中的存储逻辑"""
    # 执行存储操作
    if creep.carry(None, SPAWN) is DONE:
        # 搬运完成，切换到采集状态
        return "harvest_state"
```

### 最终代码
```python
from builtin import *

SPAWN = get.spawn()
CREEP = get.creep()
SOURCE = get.source()

class WorkerCreep(CreepLogic):
    NAME = "Worker"  # 爬虫逻辑名称
    
    def harvest_state(self, creep: Creep, k: GlobalKnowledge):
        creep.harvest(SOURCE)
        if creep.energy >= creep.energyMax:
            return "deposit_state"
    
    def deposit_state(self, creep: Creep, k: GlobalKnowledge):
        if creep.carry(None, SPAWN) is DONE:
            return "harvest_state"

def init(k: GlobalKnowledge):
    Logic("Worker", CREEP)

def step(k: GlobalKnowledge):
    pass
```
