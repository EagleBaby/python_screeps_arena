
## 9.修建建筑
  - [创建建筑工地](#创建建筑工地)
  - [获取对象](#获取对象)
  - [修建指令](#修建指令)
  - [工地管理器](#工地管理器)
  - [最终代码](#最终代码)

在本节教程中，您将会学习到如何创建新建筑。

为了修建建筑，我们需要先创建`建筑工地`（ConstructionSite，后简称site）。

### 创建建筑工地

`plan`是`ConstructionSite`的一个静态方法，用于创建一个建筑工地，构造如下:

| 参数名 | 类型 | 可选 | 默认值 | 描述 |
|-------|------|------|-------|------|
| `x` | `int` | 否 | - | 建筑工地的 x 坐标。 |
| `y` | `int` | 否 | - | 建筑工地的 y 坐标。 |
| `building_type` | `type` | 否 | - | 要创建的建筑类型。比如`StructureTower`。 |
| `single` | `bool` | 是 | `False` | 是否确保工地唯一。如果为 `True`，则不能在同一个位置重复地创建工地。 |

| 返回值类型 | 描述 |
|-----------|------|
| `int` \| `ConstructionSite` | 成功返回 `site`实例，失败返回小于 `0` 的错误码。 |

**错误码**：
- `OK` (0): 操作成功
- `ERR_NOT_OWNER` (-1): 非建筑拥有者
- `ERR_NAME_EXISTS` (-3): 该位置已存在建筑工地
- `ERR_INVALID_TARGET` (-7): 目标无效
- `ERR_FULL` (-8): 建筑工地数量达到上限
- `ERR_INVALID_ARGS` (-10): 参数不正确

**注意**：现在不允许在tick=0时新建site，需要在`init`函数中创建。


### 获取对象

本节教程为我们提供了一个带有WORK组件的Creep和一个充满能量的`box`。需要我们修筑一个Tower建筑。

```python
from builtin import *

SITE = None
CREEP = get.creep()
BOX = get.box()

def init(k: GlobalKnowledge):
    global SITE
    SITE = ConstructionSite.plan(50, 50, StructureTower)

```

### 修建指令

`build` 是 `Creep` 类的一个实例方法，构造如下：

| 参数名 | 类型 | 可选 | 默认值 | 描述 |
|-------|------|------|-------|------|
| `site` | `ConstructionSite` | 否 | - | 待修筑的建筑工地 |
| `move` | `MotionOptions` \| `bool` \| `None` | 是 | `None` | 如果传入`False`(`None`等同于`False`)，表明禁用移动。传入`True`或是一个移动指令的`options`, 那么当距离不足时会自动靠近目标 |

| 返回值类型 | 描述 |
|-----------|------|
| `int` | 成功返回 `0`，失败返回小于 `0` 的错误码，详见 `const.py`。 |

**注意**：build需要Creep消耗相应数量的能量值。

```python
# build是远程指令; fetch是资源指令。二者不冲突，可以同时
def step(k: GlobalKnowledge):
    CREEP.fetch(BOX)
    CREEP.build(SITE)
```

### 工地管理器

如果要连续地修筑建筑，受限于地图上最多存在10个site的限制，可能管理site的创建会变成一种挑战。可以使用`工地管理器`(`SitePlaner`)来负责管理Site的创建进度，将多个Site拆解为单次一个Site的形式，避免地图上Site数量超出限制导致的逻辑问题。

#### SitePlaner构造

`SitePlaner`的构造参数是一组`SitePlan`实例。后者的构造如下:

| SitePlan参数名 | 类型 | 可选 | 默认值 | 描述 |
|--------------|------|------|--------|------|
| `ref` | `Point` | - | - | 参考点 |
| `dx` | `int` | - | - | 相对于参考点的x轴偏移量 |
| `dy` | `int` | - | - | 相对于参考点的y轴偏移量 |
| `building_type` | `type` | - | - | 建筑类型 |

例如构造一个仅包含1个Tower的`SitePlaner`：

```python
SP = SitePlaner(
    SitePlan(Point(50, 50), 0, 0, StructureTower),
)
```

#### 获取site

`next`是`SitePlaner`的一个实例方法，用来获取当前tick需要修筑的`施工工地`。该函数没有参数，返回`ConstructionSite` | `None`。如果所有建筑工作都完成或被阻碍取消后，返回`None`，否则返回一个site。

```python
def step(k: GlobalKnowledge):
    site = SP.next()
    if st.site(site):
        CREEP.fetch(BOX)
        CREEP.build(site)
```

#### 示例：修筑3x3区域的Rampart

```python
from builtin import *

P50 = Point(50, 50)
SP = SitePlaner(
    SitePlan(P50, -1, -1, StructureRampart),
    SitePlan(P50, -1,  0, StructureRampart),
    SitePlan(P50, -1,  1, StructureRampart),
    SitePlan(P50,  0, -1, StructureRampart),
    SitePlan(P50,  0,  0, StructureRampart),
    SitePlan(P50,  0,  1, StructureRampart),
    SitePlan(P50,  1, -1, StructureRampart),
    SitePlan(P50,  1,  0, StructureRampart),
    SitePlan(P50,  1,  1, StructureRampart),
    SitePlan(P50,  0,  0, StructureTower),
)
CREEP = get.creep()
BOX = get.box()

def init(k: GlobalKnowledge):
    pass


def step(k: GlobalKnowledge):
    site = SP.next()
    if st.site(site):
        CREEP.fetch(BOX)
        CREEP.build(site)
```

### 最终代码

以下是修筑一个Tower建筑的完整代码：

```python
from builtin import *

SITE = None
CREEP = get.creep()
BOX = get.box()

def init(k: GlobalKnowledge):
    global SITE
    SITE = ConstructionSite.plan(50, 50, StructureTower)


def step(k: GlobalKnowledge):
    CREEP.fetch(BOX)
    CREEP.build(SITE)
```





